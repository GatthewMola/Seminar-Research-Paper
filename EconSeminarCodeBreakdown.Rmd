---
title: "SeminarCodeBreakdown"
author: "Matt Gola"
date: "3/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

``` {r Dataset Creation, include=TRUE}
library(tidyverse)
alldataclean <- read.csv("EconSeminarResearchPaperWorkbookClean.csv")

logalldatanew <- alldataclean %>%
  mutate(TGEp = (TGE / 10000)) %>%
  mutate(GPPPp = (GPPP / 1000))
```

Variable List

| Variable | Description |
|----------|-------------|
| 'FDI' | Foreign Direct Investment, net Inflows: DI equity flows in the reporting economy as percentage of GDP. |
| 'GPPP' | GDP per capita in 1000s as interpreted through the purchasing power parity (PPP). |
| 'TGDP' | Trade as percentage of GDP: sum of exports and imports of goods and services measured as a share of GDP. |
| 'RQR' | Regulatory Quality Rank: percentile rank indicates the country's rank among all countries covered by the aggregate indicator. Captures perceptions of the ability of the government to formulate sound regulations that permit and promote private sector development. |
| 'EFT' | CO2 Emissions from Transport: emissions from the combustion of fuel for all transport activity, regardless of the sector, except for international aviation. |
| 'FFEC' | Fossil Fuel Energy Consumption: percent of total energy consumption comprising coal, oil, petroleum, and natural gas products. |
| 'REO' | Renewable Electricity Output: share of electricity generated by renewable power plants in total electricity generated by all types of plants. |
| 'REC' | Renewable Energy Consumption: share of renewable energy in total final energy consumption. |
| 'TGE' | Total Greenhouse Gas Emissions in 10000 kilotons of C02: CO2 equivalent are composed of CO2 total excluding short-cycle biomass burning but including other biomass burning, all anthropogenic CH4 sources, N2O sources and F-gases. |

Omitted Variable Regression and Equation

$$\text{YlogTGE}_{it} = \beta_0+\beta_1 \text{FDI}_{it} + \beta_2 \text{logGPPP}_{it} + \beta_3 \text{TGDP}_{it} + \alpha_i + \theta_t + u_{it}$$

``` {r Omitted Pooled Least Squares Regression, include=TRUE}
library(plm)
library(huxtable)
omitted_Rreg <- plm(TGEp ~ FDI + GPPPp + TGDP, data = logalldatanew, index=c("Country","Years"), method = "within")
huxreg(omitted_Rreg)
```

Multivariate Variable Regression and Equation

$$\text{YlogTGE}_{it} = \beta_0+\beta_1 \text{FDI}_{it} + \beta_2 \text{logGPPP}_{it} + \beta_3 \text{TGDP}_{it} + \beta_4 \text{RQR}_{it} + \beta_5 \text{EFT}_{it} + \beta_6 \text{FFEC}_{it} + \alpha_i + \theta_{it} + u_{it}$$

``` {r Multivariate Pooled Least Squares Regression, include=TRUE}
multivariate_Rreg <- plm(TGEp ~ FDI + GPPPp + TGDP + RQR + EFT + FFEC + REO + REC, data = logalldatanew, index = c("Country","Years"), method="within")
huxreg(multivariate_Rreg)
```

Robust Omitted Variable Regression
(To account for outliers)

```{r Robust Omitted, include=TRUE}
library(MASS)
robust.o_Rreg <- rlm(TGEp ~ FDI + GPPPp + TGDP, data = logalldatanew)
huxreg(robust.o_Rreg)
```

Robust Multivariate Regression

``` {r Robust Multivariate Regression, include=TRUE}
robust.m_Rreg <- rlm(TGEp ~ FDI + GPPPp + TGDP + RQR + EFT + FFEC + REO + REC, data = logalldatanew)
huxreg(robust.m_Rreg)
```

Lag Effects

``` {r Lag Effects, include=FALSE}
library(Hmisc)
logalldatalag <- logalldatanew %>%
  mutate(lagGPPPp = Lag(GPPPp, 1),
         lagTGDP = Lag(TGDP, 1))
```

Regression Tables

``` {r Regression Tables - Fixed Effects, include=TRUE}
library(plm)
library(huxtable)
omitted_Rreg_fixed <- plm(TGEp ~ FDI + GPPPp + TGDP, data = logalldatanew, index=c("Country","Years"), method = "within", effect = "twoways")

lagomitted_Rreg_fixed <- plm(TGEp ~ FDI + lagGPPPp + lagTGDP, data = logalldatalag, index = c("Country","Years"), method = "within", effect = "twoways")

multivariate_Rreg_fixed <- plm(TGEp ~ FDI + GPPPp + TGDP + RQR + EFT + FFEC, data = logalldatanew, index = c("Country","Years"), method="within", effect = "twoways")

lagmultivaraite_Rreg_fixed <- plm(TGEp ~ FDI + lagGPPPp + lagTGDP + RQR + EFT + FFEC, data = logalldatalag, index = c("Country","Years"), method = "within", effect = "twoways")

huxreg("Omitted" = omitted_Rreg, "Lag Omitted" = lagomitted_Rreg_fixed, "Multivariate" = multivariate_Rreg, "Lag Multivaraite" = lagmultivaraite_Rreg_fixed, 
       statistics = c("N" = "nobs",
                      "R-squared" = "r.squared",
                      "SER" = "sigma"),
       number_format = 4)
```

``` {r Random Effects, include=TRUE}
omitted_Rreg_random <- plm(TGEp ~ FDI + GPPPp + TGDP, data = logalldatanew, index=c("Country","Years"), method = "random", effect = "twoways")

multivariate_Rreg_random <- plm(TGEp ~ FDI + GPPPp + TGDP + RQR + EFT + FFEC + REO + REC, data = logalldatanew, index = c("Country","Years"), method="random", effect = "twoways")

```

``` {r New Multivariate Regression, include=TRUE}
newmultivariate_Rreg_fixed <- plm(TGEp ~ FDI + GPPPp + TGDP + RQR + EFT + FFEC, data = logalldatanew, index = c("Country","Years"), method="within", effect = "twoways")
huxreg(newmultivariate_Rreg_fixed)
#This is better!
```

``` {r New Regressions with Lag Effects, include=TRUE}
lagomitted_Rreg_fixed <- plm(TGEp ~ FDI + lagGPPPp + lagTGDP, data = logalldatalag, index = c("Country","Years"), method = "within", effect = "twoways")

lagmultivaraite_Rreg_fixed <- plm(TGEp ~ FDI + lagGPPPp + lagTGDP + RQR + EFT + FFEC, data = logalldatalag, index = c("Country","Years"), method = "within", effect = "twoways")

huxreg(lagomitted_Rreg_fixed, lagmultivaraite_Rreg_fixed)

#Unfortunately the lag effect does nothing to help the regression
```

De-meaning data to isolate country fixed effects:

``` {r, include=TRUE}
means_countries <- logalldatanew %>%
        group_by(Country) %>%
        mutate(avg_TGEp = mean(TGEp),
                  avg_FDI = mean(FDI),
                  avg_GPPPp = mean(GPPPp),
                  avg_TGDP = mean(TGDP),
                  avg_RQR = mean(RQR),
                  avg_EFT = mean(EFT),
                  avg_FFEC = mean(FFEC),
                  avg_REO = mean(REO),
                  avg_REC = mean(REC))
# Now subtract the mean from every observation
# Mutate a new variable of "GDP minus mean(GDP)"
```

Isolating year effects:

``` {r, include=TRUE}
means_years <- logalldatanew %>%
        group_by(Years) %>%
        mutate(avg_TGEp = mean(TGEp),
                  avg_FDI = mean(FDI),
                  avg_GPPPp = mean(GPPPp),
                  avg_TGDP = mean(TGDP),
                  avg_RQR = mean(RQR),
                  avg_EFT = mean(EFT),
                  avg_FFEC = mean(FFEC),
                  avg_REO = mean(REO),
                  avg_REC = mean(REC))
# Now take the mean away and set it to zero
```

Isolating Both in New Dataset

``` {r, include=TRUE}
logalldataiso <- logalldatanew %>%
  mutate(deFDI = (FDI - mean(FDI)),
         deTGDP = (TGDP - mean(TGDP)),
         deRQR = (RQR - mean(RQR)),
         deEFT = (EFT - mean(EFT)),
         deFFEC = (FFEC - mean(FFEC)),
         deREO = (REO - mean(REO)),
         deREC = (REC - mean(REC)),
         deTGEp = (TGEp - mean(TGEp)),
         deGPPPp = (GPPPp - mean(GPPPp)))
```

Creating Lag Effect

``` {r, include=TRUE}
library(Hmisc)
logalldatalag <- logalldatanew %>%
  mutate(lagGPPPp = Lag(GPPPp, 1),
         lagTGDP = Lag(TGDP, 1))
```

# Histograms

## Non-Meaned Histogram

``` {r Visualization of Non De-Meaned Data, include=TRUE}
ggplot(data = logalldataiso)+
        aes(x = TGEp,
            y = GPPPp,
            color = Country)+
        geom_point()+
        geom_smooth(method = "lm")+
        labs(x = "log Total Greenhouse Gas Emissions",
             y = "log GDP per Capita, PPP",
             color = NULL)
```

## Segment Histograms of Meaned Regulatory Covariates + TGDP and GPPP (By Country)

``` {r Visualize Meaned Country Data (TGE v GPPP), include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_GPPPp,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_GPPPp,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average GDP per Capita, PPP (1,000s)",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

``` {r Meaned Country Data (TGE v EFT), include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_EFT,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_EFT,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average Emissions From Transport",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

``` {r Meaned Country Data (TGE v TGDP), include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_TGDP,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_TGDP,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average Trade as % of GDP",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

``` {r Meaned Country Data (TGE v FFEC), include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_FFEC,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_FFEC,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average Fossil Fuel Energy Consumption",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

``` {r Meaned Country Data (TGE v RQR), include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_RQR,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_RQR,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average Regulatory Quality Rank",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

``` {r Meaned Country Data (TGE v FDI), fig.height=11, fig.width=12, include=TRUE}
ggplot(data=means_countries)+
        aes(x = fct_reorder(Country, avg_TGEp),
            y = avg_FDI,
            color = Country)+
        geom_point()+
        geom_segment(aes(y=0,
                         yend = avg_FDI,
                         x = Country,
                         xend = Country))+
        coord_flip()+
        labs(x = "Countries by Average Foreign Direct Investment, Net Inflows",
             y = "Average Total Greenhouse Gas Emissions (10,000s)")+
        theme(legend.position = "none")
```

## Year Effects Histogram:

``` {r Further Visualization of Year Effects, include=TRUE}
ggplot(data=logalldatanew)+
        aes(x = Years,
            y = TGEp)+
        geom_point(aes(color = Years))+
        geom_point(data = means_years,
                   aes(x = Years,
                       y = avg_TGEp),
                   size = 3,
                   color = "black")+
        labs(x = "Year",
             y = "Average log Total Greenhouse Gas Emissions")+
        theme(legend.position = "none")
```

## Histograms of De-Meaned Regulatory Covariates + TGDP / GPPP / FDI:

``` {r De-Meaned Non-log Histogram (TGE v GPPP), include=TRUE}
ggplot(data=logalldataiso)+
  aes(x = deTGEp,
      y = deGPPPp)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "GDP per Capita, PPP (1,000s)")
```

``` {r De-Meaned TGE v EFT, include=TRUE}
ggplot(logalldataiso)+
  aes(x = deTGEp,
      y = deEFT)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "Emissions from Transport")
```

``` {r De-Meaned TGE v FFEC, include=TRUE}
ggplot(logalldataiso)+
  aes(x = deTGEp,
      y = deFFEC)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "Fossil Fuel Energy Consumption")
```

``` {r De-Meaned TGE v TGDP, include=TRUE}
ggplot(logalldataiso)+
  aes(x = deTGEp,
      y = deTGDP)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "Trade as % of GDP")
```

``` {r De-Meaned TGE v RQR, include=TRUE}
ggplot(logalldataiso)+
  aes(x = deTGEp,
      y = deRQR)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "Regulatory Quality Rank")
```

```{r De-Meaned TGE v FDI, include=TRUE}
ggplot(logalldataiso)+
  aes(x = deTGEp,
      y = deFDI)+
  geom_point(aes(color = Country))+
  geom_smooth(method = "lm")+
  labs(x = "Total Greenhouse Gas Emissions (10,000s)",
       y = "Foreign Direct Investment, net Inflows")
```

# Correlation Heat Map

``` {r Tile Heat Map Pretty, include=TRUE}
library(reshape2)
logalldatanewcor <- logalldatanew[, c(3,5,6,8,9,12,13)]
cormat <- round(cor(logalldatanewcor), 2)
melted_cormat <- melt(cormat)
# Get lower triangle of the correlation matrix
get_lower_tri <- function(cormat){
        cormat[upper.tri(cormat)] <- NA
        return(cormat)
}

# Get upper triangle of the correlation matrix
get_upper_tri <- function(cormat){
        cormat[lower.tri(cormat)] <- NA
        return(cormat)
}

upper_tri <- get_upper_tri(cormat)
lower_tri <- get_lower_tri(cormat)

# Melt the correlation matrix
melted_cormat_pretty <- melt(upper_tri, na.rm = TRUE)

# Heatmap
ggplot(data = melted_cormat_pretty, aes(Var2, Var1, fill=value))+
        geom_tile(color = "white")+
        scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1), space = "Lab", name="Correlation\nValue")+
        theme_minimal()+
        theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1))+
        coord_fixed()
```

# Reorder Heatmap

``` {r Reorder, include=TRUE}
library(reshape2)
#Reorder Heatmap
reorder_cormat <- function(cormat){
        # Use correlation between variables as distance
        dd <- as.dist((1-cormat)/2)
        hc <- hclust(dd)
        cormat <- cormat[hc$order, hc$order]
}

# Reorder the matrix
cormat <- reorder_cormat(cormat)
upper_tri <- get_upper_tri(cormat)
# Melt the correlation matrix
melted_cormat <- melt(upper_tri, na.rm = TRUE)
# Create the ggheatmap
ggheatmap <- ggplot(melted_cormat, aes(Var2, Var1, fill = value))+
        geom_tile(color = "white")+
        scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1), space = "Lab", name = "Correlation Value")+
        theme_minimal()+
        coord_fixed()+
        geom_text(aes(Var2, Var1, label = value), color = "black", size = 4)+
        theme(
                axis.title.x = element_blank(),
                axis.title.y = element_blank(),
                panel.grid.major = element_blank(),
                panel.background = element_blank(),
                axis.ticks = element_blank(),
                legend.justification = c(1,0),
                legend.position = c(0.6,0.7),
                legend.direction = "horizontal")+
        guides(fill = guide_colorbar(barwidth = 7, barheight = 1, title.position = "top", title.hjust = 0.5))
```

``` {r, include=TRUE}
ggheatmap
```